# Logstash è§„åˆ™æµ‹è¯•å·¥å…· - ä½¿ç”¨æŒ‡å—

## ğŸ¯ é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ Logstash è§„åˆ™æµ‹è¯•å·¥å…·ï¼Œé€šè¿‡ Docker éƒ¨ç½²ï¼Œæä¾› Web ç•Œé¢æ¥ç¼–è¾‘å’Œæµ‹è¯• Logstash pipeline è§„åˆ™ã€‚

### âœ¨ ä¸»è¦åŠŸèƒ½

- ğŸ”§ Web ç•Œé¢ç¼–è¾‘ Logstash filter è§„åˆ™
- ğŸš€ å®æ—¶å‘é€æµ‹è¯•æ—¥å¿—
- ğŸ“Š å³æ—¶æŸ¥çœ‹è§£æç»“æœ
- ğŸ”¥ æ”¯æŒçƒ­é‡è½½ï¼ˆ3ç§’å†…ç”Ÿæ•ˆï¼‰
- ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
./start.sh

# æˆ–æ‰‹åŠ¨å¯åŠ¨
docker-compose up -d --build
```

### 2. è®¿é—® Web ç•Œé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:19000

### 3. åŸºæœ¬ä½¿ç”¨æµç¨‹

1. **ç¼–è¾‘ Filter è§„åˆ™**ï¼šåœ¨å·¦ä¾§æ–‡æœ¬æ¡†ç¼–è¾‘ Logstash filter é…ç½®
2. **ä¿å­˜é…ç½®**ï¼šç‚¹å‡»"ä¿å­˜ Filter"æŒ‰é’®ï¼Œè§„åˆ™ä¼šè‡ªåŠ¨çƒ­é‡è½½
3. **è¾“å…¥æµ‹è¯•æ—¥å¿—**ï¼šåœ¨å³ä¾§æ–‡æœ¬æ¡†è¾“å…¥è¦æµ‹è¯•çš„æ—¥å¿—å†…å®¹
4. **å‘é€æµ‹è¯•**ï¼šç‚¹å‡»"å‘é€å¹¶æŸ¥çœ‹è§£æç»“æœ"
5. **æŸ¥çœ‹ç»“æœ**ï¼šåœ¨åº•éƒ¨æŸ¥çœ‹ JSON æ ¼å¼çš„è§£æç»“æœ

## ğŸ“ ç¤ºä¾‹é…ç½®

### Apache è®¿é—®æ—¥å¿—

```logstash
filter {
  grok { 
    match => { "message" => "%{COMBINEDAPACHELOG}" } 
  }
  mutate { 
    rename => { "clientip" => "src_ip" } 
  }
  date { 
    match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"] 
    target => "@timestamp"
  }
}
```

**æµ‹è¯•æ—¥å¿—ï¼š**
```
127.0.0.1 - - [25/Dec/2023:10:00:00 +0000] "GET /index.html HTTP/1.1" 200 2326
```

### JSON åº”ç”¨æ—¥å¿—

```logstash
filter {
  json { 
    source => "message" 
  }
  date { 
    match => ["timestamp", "ISO8601"] 
    target => "@timestamp" 
  }
  if [level] {
    mutate { 
      uppercase => [ "level" ] 
    }
  }
}
```

**æµ‹è¯•æ—¥å¿—ï¼ˆéœ€å‹¾é€‰ JSON é€‰é¡¹ï¼‰ï¼š**
```json
{"timestamp": "2023-12-25T10:00:00Z", "level": "info", "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ", "user_id": 12345}
```

### Syslog æ—¥å¿—

```logstash
filter {
  grok {
    match => { "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{PROG:program}: %{GREEDYDATA:log_message}" }
  }
  date {
    match => [ "timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
  }
}
```

**æµ‹è¯•æ—¥å¿—ï¼š**
```
Dec 25 10:00:00 server01 sshd[1234]: Accepted password for user from 192.168.1.100
```

## ğŸ› ï¸ å¸¸ç”¨æ“ä½œ

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€
```bash
docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—
```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ Logstash æ—¥å¿—
docker-compose logs -f logstash

# æŸ¥çœ‹ Web åº”ç”¨æ—¥å¿—
docker-compose logs -f web
```

### é‡å¯æœåŠ¡
```bash
docker-compose restart
```

### åœæ­¢æœåŠ¡
```bash
docker-compose down
```

### å®Œå…¨æ¸…ç†
```bash
docker-compose down -v --rmi all
```

## ğŸ“Š ç«¯å£ä¿¡æ¯

- **19000**: Web ç•Œé¢ç«¯å£
- **15515**: Logstash HTTP è¾“å…¥ç«¯å£ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

## ğŸ“ ç›®å½•ç»“æ„

```
logstash-lab/
â”œâ”€â”€ docker-compose.yml          # Docker ç¼–æ’é…ç½®
â”œâ”€â”€ start.sh                    # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ web/                        # Web åº”ç”¨
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ app.py                  # Flask åº”ç”¨
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ index.html          # Web ç•Œé¢
â”œâ”€â”€ logstash/                   # Logstash é…ç½®
â”‚   â”œâ”€â”€ logstash.yml           # Logstash ä¸»é…ç½®
â”‚   â”œâ”€â”€ pipelines.yml          # Pipeline é…ç½®
â”‚   â””â”€â”€ pipeline/
â”‚       â””â”€â”€ test.conf          # Pipeline è§„åˆ™æ–‡ä»¶
â””â”€â”€ data/                      # æ•°æ®ç›®å½•
    â””â”€â”€ out/
        â””â”€â”€ events.ndjson      # è§£æç»“æœè¾“å‡º
```

## ğŸ”§ é«˜çº§é…ç½®

### ä¿®æ”¹ç«¯å£

ç¼–è¾‘ `docker-compose.yml` æ–‡ä»¶ä¸­çš„ç«¯å£æ˜ å°„ï¼š

```yaml
services:
  web:
    ports:
      - "19000:19000"  # ä¿®æ”¹ä¸ºä½ æƒ³è¦çš„ç«¯å£
```

### è°ƒæ•´å†…å­˜ä½¿ç”¨

ç¼–è¾‘ `docker-compose.yml` ä¸­çš„ Logstash ç¯å¢ƒå˜é‡ï¼š

```yaml
environment:
  - LS_JAVA_OPTS=-Xms512m -Xmx1024m  # è°ƒæ•´å†…å­˜é™åˆ¶
```

### æŒä¹…åŒ–æ•°æ®

æ•°æ®ç›®å½• `./data` å·²ç»æŒ‚è½½åˆ°å®¹å™¨ï¼Œè§£æç»“æœä¼šæŒä¹…åŒ–ä¿å­˜ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**ï¼šæ­¤å·¥å…·ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæš´éœ² 15515 ç«¯å£
2. **èµ„æºä½¿ç”¨**ï¼šLogstash ä¼šå ç”¨ä¸€å®šå†…å­˜ï¼Œå»ºè®®è‡³å°‘ 1GB å¯ç”¨å†…å­˜
3. **çƒ­é‡è½½æ—¶é—´**ï¼šFilter è§„åˆ™ä¿®æ”¹åçº¦ 3 ç§’ç”Ÿæ•ˆ
4. **æ—¥å¿—æ ¼å¼**ï¼šæ”¯æŒ text/plain å’Œ application/json ä¸¤ç§è¾“å…¥æ ¼å¼

## ğŸ› æ•…éšœæ’é™¤

### æ— æ³•è®¿é—® Web ç•Œé¢
1. æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œï¼š`docker ps`
2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :19000`
3. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`docker-compose logs web`

### Logstash å¯åŠ¨å¤±è´¥
1. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•ï¼šæŸ¥çœ‹ `docker-compose logs logstash`
2. æ£€æŸ¥å†…å­˜æ˜¯å¦è¶³å¤Ÿ
3. ç¡®ä¿ç«¯å£ 15515 æœªè¢«å ç”¨

### Filter è§„åˆ™ä¸ç”Ÿæ•ˆ
1. æ£€æŸ¥è¯­æ³•æ˜¯å¦æ­£ç¡®
2. ç­‰å¾… 3-5 ç§’è®©çƒ­é‡è½½ç”Ÿæ•ˆ
3. æŸ¥çœ‹ Logstash æ—¥å¿—ç¡®è®¤é‡è½½æˆåŠŸ

## ğŸ“š ç›¸å…³èµ„æº

- [Logstash å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/logstash/current/index.html)
- [Grok æ¨¡å¼å‚è€ƒ](https://github.com/elastic/logstash/blob/v1.4.2/patterns/grok-patterns)
- [Logstash Filter æ’ä»¶](https://www.elastic.co/guide/en/logstash/current/filter-plugins.html)

---

ğŸ‰ **ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å®¹å™¨æ—¥å¿—è¿›è¡Œæ’æŸ¥ã€‚**
