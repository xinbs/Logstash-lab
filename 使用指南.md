# Logstash 规则测试工具 - 使用指南

## 🎯 项目简介

这是一个简单易用的 Logstash 规则测试工具，通过 Docker 部署，提供 Web 界面来编辑和测试 Logstash pipeline 规则。

### ✨ 主要功能

- 🔧 Web 界面编辑 Logstash filter 规则
- 🚀 实时发送测试日志
- 📊 即时查看解析结果
- 🔥 支持热重载（3秒内生效）
- 📱 响应式设计，支持移动端

## 🚀 快速开始

### 1. 启动服务

```bash
# 使用启动脚本（推荐）
./start.sh

# 或手动启动
docker-compose up -d --build
```

### 2. 访问 Web 界面

打开浏览器访问：http://localhost:19000

### 3. 基本使用流程

1. **编辑 Filter 规则**：在左侧文本框编辑 Logstash filter 配置
2. **保存配置**：点击"保存 Filter"按钮，规则会自动热重载
3. **输入测试日志**：在右侧文本框输入要测试的日志内容
4. **发送测试**：点击"发送并查看解析结果"
5. **查看结果**：在底部查看 JSON 格式的解析结果

## 📝 示例配置

### Apache 访问日志

```logstash
filter {
  grok { 
    match => { "message" => "%{COMBINEDAPACHELOG}" } 
  }
  mutate { 
    rename => { "clientip" => "src_ip" } 
  }
  date { 
    match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"] 
    target => "@timestamp"
  }
}
```

**测试日志：**
```
127.0.0.1 - - [25/Dec/2023:10:00:00 +0000] "GET /index.html HTTP/1.1" 200 2326
```

### JSON 应用日志

```logstash
filter {
  json { 
    source => "message" 
  }
  date { 
    match => ["timestamp", "ISO8601"] 
    target => "@timestamp" 
  }
  if [level] {
    mutate { 
      uppercase => [ "level" ] 
    }
  }
}
```

**测试日志（需勾选 JSON 选项）：**
```json
{"timestamp": "2023-12-25T10:00:00Z", "level": "info", "message": "用户登录成功", "user_id": 12345}
```

### Syslog 日志

```logstash
filter {
  grok {
    match => { "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{PROG:program}: %{GREEDYDATA:log_message}" }
  }
  date {
    match => [ "timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
  }
}
```

**测试日志：**
```
Dec 25 10:00:00 server01 sshd[1234]: Accepted password for user from 192.168.1.100
```

## 🛠️ 常用操作

### 查看容器状态
```bash
docker-compose ps
```

### 查看日志
```bash
# 查看所有日志
docker-compose logs -f

# 查看 Logstash 日志
docker-compose logs -f logstash

# 查看 Web 应用日志
docker-compose logs -f web
```

### 重启服务
```bash
docker-compose restart
```

### 停止服务
```bash
docker-compose down
```

### 完全清理
```bash
docker-compose down -v --rmi all
```

## 📊 端口信息

- **19000**: Web 界面端口
- **15515**: Logstash HTTP 输入端口（内部使用）

## 📁 目录结构

```
logstash-lab/
├── docker-compose.yml          # Docker 编排配置
├── start.sh                    # 启动脚本
├── web/                        # Web 应用
│   ├── Dockerfile
│   ├── app.py                  # Flask 应用
│   └── templates/
│       └── index.html          # Web 界面
├── logstash/                   # Logstash 配置
│   ├── logstash.yml           # Logstash 主配置
│   ├── pipelines.yml          # Pipeline 配置
│   └── pipeline/
│       └── test.conf          # Pipeline 规则文件
└── data/                      # 数据目录
    └── out/
        └── events.ndjson      # 解析结果输出
```

## 🔧 高级配置

### 修改端口

编辑 `docker-compose.yml` 文件中的端口映射：

```yaml
services:
  web:
    ports:
      - "19000:19000"  # 修改为你想要的端口
```

### 调整内存使用

编辑 `docker-compose.yml` 中的 Logstash 环境变量：

```yaml
environment:
  - LS_JAVA_OPTS=-Xms512m -Xmx1024m  # 调整内存限制
```

### 持久化数据

数据目录 `./data` 已经挂载到容器，解析结果会持久化保存。

## ⚠️ 注意事项

1. **安全性**：此工具仅用于测试环境，不要在生产环境暴露 15515 端口
2. **资源使用**：Logstash 会占用一定内存，建议至少 1GB 可用内存
3. **热重载时间**：Filter 规则修改后约 3 秒生效
4. **日志格式**：支持 text/plain 和 application/json 两种输入格式

## 🐛 故障排除

### 无法访问 Web 界面
1. 检查 Docker 是否运行：`docker ps`
2. 检查端口是否被占用：`lsof -i :19000`
3. 查看容器日志：`docker-compose logs web`

### Logstash 启动失败
1. 检查配置文件语法：查看 `docker-compose logs logstash`
2. 检查内存是否足够
3. 确保端口 15515 未被占用

### Filter 规则不生效
1. 检查语法是否正确
2. 等待 3-5 秒让热重载生效
3. 查看 Logstash 日志确认重载成功

## 📚 相关资源

- [Logstash 官方文档](https://www.elastic.co/guide/en/logstash/current/index.html)
- [Grok 模式参考](https://github.com/elastic/logstash/blob/v1.4.2/patterns/grok-patterns)
- [Logstash Filter 插件](https://www.elastic.co/guide/en/logstash/current/filter-plugins.html)

---

🎉 **祝你使用愉快！如有问题，请查看容器日志进行排查。**
