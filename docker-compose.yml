version: "3.9"
services:
  logstash:
    image: docker.elastic.co/logstash/logstash:8.14.2
    container_name: logstash-lab
    ports:
      - "15515:15515"       # http input（内网用，别暴露公网）
    environment:
      - LS_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      - ./logstash/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
      - ./logstash/pipelines.yml:/usr/share/logstash/config/pipelines.yml:ro
      - ./logstash/pipeline:/usr/share/logstash/pipeline
      - ./data:/data
      - ./logs:/usr/share/logstash/logs    # 挂载日志目录
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -sS http://127.0.0.1:9600/_node/pipelines | grep -q test"]
      interval: 5s
      timeout: 3s
      retries: 20

  web:
    build: ./web
    container_name: logstash-lab-web
    ports:
      - "19000:19000"
    volumes:
      - ./logstash/pipeline:/app/pipeline         # 写 filter
      - ./data:/app/data                          # 读结果
      - ./web/app.py:/app/app.py                  # 开发时热更新
      - ./web/templates:/app/templates            # 开发时热更新
      - /var/run/docker.sock:/var/run/docker.sock # Docker socket for logs
    environment:
      - LOGSTASH_HTTP=http://logstash:15515       # 发送日志
      - FLASK_ENV=development                     # 开发模式，支持自动重载
    depends_on:
      - logstash

  mcp-server:
    build: ./mcp_server
    command: python mcp_server.py
    container_name: logstash-lab-mcp
    ports:
      - "19001:19001"
    volumes:
      - ./mcp_server/mcp_server.py:/app/mcp_server.py    # 开发时热更新
      - ./mcp_server/requirements.txt:/app/requirements.txt  # 依赖文件
    environment:
      - LOGSTASH_SERVICE_URL=http://web:19000
      - FLASK_ENV=development                           # 开发模式，支持自动重载
    depends_on:
      - web
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19001/tools/health_check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
