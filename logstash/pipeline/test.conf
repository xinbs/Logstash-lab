input {
  http {
    port => 15515
    additional_codecs => { "application/json" => "json" }
    # text/plain 会落在 [message] 字段
  }
}

# 自动设置 metadata type 为固定值 "test" (为了兼容现有逻辑)
filter {
  mutate {
    add_field => { "[@metadata][type]" => "test" }
  }
}

### !!! Web 会把下面 filter {...} 整块替换 !!!
filter {
    if "test" == [@metadata][type] {
        grok {
        match => {
        "message" => [
        # 原有的解析规则保持不变
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %FTD-%{WORD:level}-%{WORD:event_id}: %{GREEDYDATA:event_action} %{INT:connection_id} from %{NOTSPACE:src_interface}:%{IP:src_ip}/%{INT:src_port} \(%{IP:src_ip_raw}/%{INT:src_port_raw}\) to %{NOTSPACE:dst_interface}:%{IP:dst_ip}/%{INT:dst_port} \(%{IP:dst_ip_raw}/%{INT:dst_port_raw}\)",
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %FTD-%{INT:level}-%{INT:event_id}: %{GREEDYDATA:event_action} connection %{INT:connection_id} from %{NOTSPACE:src_interface}:%{IP:src_ip}/%{INT:src_port} to %{NOTSPACE:dst_interface}:%{IP:dst_ip}/%{INT:dst_port} duration %{DATA:duration} bytes %{INT:bytes} %{GREEDYDATA:termination_reason}",

        # FTD-2-106016: IP欺骗检测
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: Deny IP spoof from \(%{IP:src_ip}\) to %{IP:dst_ip} on interface %{WORD:interface}",

        # FTD-4-430001: 入侵检测事件 (复杂格式)
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: DeviceUUID: %{DATA:device_uuid}, InstanceID: %{INT:instance_id}, FirstPacketSecond: %{DATA:first_packet_time}, ConnectionID: %{INT:connection_id}, SrcIP: %{IP:src_ip}, DstIP: %{IP:dst_ip}, SrcPort: %{INT:src_port}, DstPort: %{INT:dst_port}, Protocol: %{WORD:protocol}, IngressInterface: %{DATA:ingress_interface}, EgressInterface: %{DATA:egress_interface}, Priority: %{INT:priority_level}, GID: %{INT:gid}, SID: %{INT:sid}, Revision: %{INT:revision}, Message: %{DATA:alert_message}, Classification: %{DATA:classification}, Client: %{DATA:client}, ApplicationProtocol: %{DATA:app_protocol}, IntrusionPolicy: %{DATA:intrusion_policy}, ACPolicy: %{DATA:ac_policy}, AccessControlRuleName: %{DATA:ac_rule_name}, NAPPolicy: %{DATA:nap_policy}, InlineResult: %{WORD:inline_result}",

        # FTD-4-500004: 无效传输字段
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: Invalid transport field for protocol=%{WORD:protocol}, from %{IP:src_ip}/%{INT:src_port} to %{IP:dst_ip}/%{INT:dst_port}",

        # FTD-4-733100: 扫描检测
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: \[ %{WORD:scan_type}\] drop rate-%{INT:rate_id} exceeded\. Current burst rate is %{INT:current_burst_rate} per second, max configured rate is %{INT:max_burst_rate}; Current average rate is %{INT:current_avg_rate} per second, max configured rate is %{INT:max_avg_rate}; Cumulative total count is %{INT:cumulative_count}",

        # FTD-5-111001: 配置开始
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: Begin configuration: %{GREEDYDATA:config_action}",

        # FTD-5-111004: 配置结束
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: %{WORD:config_source} end configuration: %{WORD:config_status}",

        # FTD-5-111008: 用户命令执行
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: User '%{DATA:username}' executed the '%{DATA:command}' command\.",

        # FTD-5-111010: 用户操作记录
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: User '%{DATA:username}', running '%{DATA:running_context}' from IP %{IP:user_ip}, executed '%{DATA:executed_command}'",

        # FTD-5-199017: 系统操作
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: sudo:%{SPACE}+%{DATA:sudo_user} : PWD=%{DATA:pwd} ; USER=%{DATA:target_user} ; COMMAND=%{GREEDYDATA:sudo_command}",

        # FTD-5-500003: TCP头部错误
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: Bad TCP hdr length \(hdrlen=%{INT:header_length}, pktlen=%{INT:packet_length}\) from %{IP:src_ip}/%{INT:src_port} to %{IP:dst_ip}/%{INT:dst_port}, flags: %{WORD:tcp_flags}, on interface %{WORD:interface}",

        # FTD-6-302010: 连接使用统计
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: %{INT:connections_in_use} in use, %{INT:max_connections_used} most used",

        # FTD-6-302303: TCP连接建立 (可能被截断)
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: Built TCP state-bypass %{GREEDYDATA:connection_info}",

        # 通用FTD日志格式 (兜底匹配)
        "<%{INT:priority}>%{GREEDYDATA:log_times} %{HOSTNAME:syslog_hostname} : %%FTD-%{INT:level}-%{INT:event_id}: %{GREEDYDATA:message_content}"
        ]
        }
        }
        mutate {
        add_field => {
        "log_source_device" => "Cisco Firepower IPS @ %{[syslog_hostname]}"
        "__source" => "cisco_firepower_ips"
        }
        remove_field => ["event"]
        }
    }
}

output {
  file {
    path => "/data/out/events.ndjson"
    codec => json_lines
  }
  stdout { codec => rubydebug }
}